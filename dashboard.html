<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - AI Chat Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .session-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .session-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(139, 92, 246, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.2);
        }
        
        .session-card.active {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.5);
        }
        
        .chat-area {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(139, 92, 246, 0.5) transparent;
        }
        
        .chat-area::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-area::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-area::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.5);
            border-radius: 3px;
        }
        
        .message-bubble {
            animation: slideInUp 0.5s ease-out forwards;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .status-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .admin-avatar {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .user-avatar {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }
        
        .logout-button {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            transition: all 0.3s ease;
        }
        
        .logout-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body class="text-white">
    <!-- Header -->
    <header class="glass-morphism p-4 mb-6">
        <div class="flex items-center justify-between max-w-6xl mx-auto">
            <div class="flex items-center space-x-4">
                <div class="admin-avatar w-10 h-10 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-semibold">Admin Dashboard</h1>
                    <p class="text-xs text-green-400">Default User Active</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div class="status-indicator w-2 h-2 bg-green-400 rounded-full"></div>
                    <span class="text-sm text-gray-300" id="active-sessions">0 Active Sessions</span>
                </div>
                <button id="logout-button" class="logout-button px-4 py-2 rounded-lg text-sm font-medium">
                    Logout
                </button>
            </div>
        </div>
    </header>

    <div class="max-w-6xl mx-auto px-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Sessions Panel -->
            <div class="lg:col-span-1">
                <div class="glass-morphism rounded-lg p-4 mb-4">
                    <h2 class="text-lg font-semibold mb-4">Active Chat Sessions</h2>
                    <div id="sessions-list" class="space-y-3">
                        <!-- Sessions will be loaded here -->
                    </div>
                </div>
                
                <!-- System Stats -->
                <div class="glass-morphism rounded-lg p-4">
                    <h3 class="text-md font-semibold mb-3">System Stats</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-300">Total Sessions:</span>
                            <span id="total-sessions">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Messages Today:</span>
                            <span id="messages-today">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">System Status:</span>
                            <span class="text-green-400">Online</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Panel -->
            <div class="lg:col-span-2">
                <div class="glass-morphism rounded-lg p-4">
                    <!-- Chat Header -->
                    <div class="flex items-center justify-between mb-4 pb-4 border-b border-gray-600">
                        <div class="flex items-center space-x-3">
                            <div class="user-avatar w-8 h-8 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div>
                                <h3 id="current-session" class="font-semibold">Select a session</h3>
                                <p id="session-info" class="text-xs text-gray-400">Choose a session to start chatting</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="clear-chat" class="text-sm text-gray-400 hover:text-white px-3 py-1 rounded">
                                Clear Chat
                            </button>
                            <button id="end-session" class="text-sm text-red-400 hover:text-red-300 px-3 py-1 rounded">
                                End Session
                            </button>
                        </div>
                    </div>

                    <!-- Chat Area -->
                    <div id="chat-area" class="chat-area space-y-4 mb-4 min-h-96">
                        <div class="text-center text-gray-400 py-8">
                            <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                            </svg>
                            <p>Select a chat session to begin</p>
                        </div>
                    </div>

                    <!-- Message Input -->
                    <div class="flex items-center space-x-3">
                        <input 
                            type="text" 
                            id="message-input" 
                            placeholder="Type your message..."
                            class="flex-1 px-4 py-3 rounded-lg bg-white bg-opacity-10 border border-white border-opacity-20 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 focus:bg-opacity-15"
                            disabled
                        >
                        <button 
                            id="send-button" 
                            class="bg-gradient-to-r from-blue-500 to-purple-600 px-6 py-3 rounded-lg text-white font-semibold hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class AdminDashboard {
            constructor() {
                this.currentSessionId = null;
                this.sessions = new Map();
                this.messageInput = document.getElementById('message-input');
                this.sendButton = document.getElementById('send-button');
                this.chatArea = document.getElementById('chat-area');
                this.sessionsList = document.getElementById('sessions-list');
                
                this.initializeEventListeners();
                this.loadSessions();
                this.startPolling();
            }
            
            initializeEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
                
                document.getElementById('logout-button').addEventListener('click', () => this.logout());
                document.getElementById('clear-chat').addEventListener('click', () => this.clearChat());
                document.getElementById('end-session').addEventListener('click', () => this.endSession());
            }
            
            async loadSessions() {
                try {
                    const response = await fetch('/api/admin/sessions');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.updateSessionsList(data.sessions);
                        this.updateStats(data.stats);
                    }
                } catch (error) {
                    console.error('Error loading sessions:', error);
                }
            }
            
            updateSessionsList(sessions) {
                this.sessionsList.innerHTML = '';
                
                if (sessions.length === 0) {
                    this.sessionsList.innerHTML = `
                        <div class="text-center text-gray-400 py-4">
                            <p class="text-sm">No active sessions</p>
                        </div>
                    `;
                    return;
                }
                
                sessions.forEach(session => {
                    const sessionCard = document.createElement('div');
                    sessionCard.className = `session-card rounded-lg p-3 cursor-pointer ${session.id === this.currentSessionId ? 'active' : ''}`;
                    sessionCard.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium">Session ${session.id.substr(-4)}</span>
                            <span class="text-xs text-green-400">Active</span>
                        </div>
                        <p class="text-xs text-gray-300 mb-2">${session.lastMessage || 'No messages yet'}</p>
                        <div class="flex justify-between text-xs text-gray-400">
                            <span>${session.messageCount} messages</span>
                            <span>${this.formatTime(session.lastActive)}</span>
                        </div>
                    `;
                    
                    sessionCard.addEventListener('click', () => this.selectSession(session.id));
                    this.sessionsList.appendChild(sessionCard);
                });
                
                // Update active sessions count
                document.getElementById('active-sessions').textContent = `${sessions.length} Active Sessions`;
            }
            
            updateStats(stats) {
                document.getElementById('total-sessions').textContent = stats.totalSessions || 0;
                document.getElementById('messages-today').textContent = stats.messagesToday || 0;
            }
            
            selectSession(sessionId) {
                this.currentSessionId = sessionId;
                this.loadChatHistory(sessionId);
                this.enableChatInput();
                
                // Update UI
                document.getElementById('current-session').textContent = `Session ${sessionId.substr(-4)}`;
                document.getElementById('session-info').textContent = 'Connected • Ready to chat';
                
                // Update session cards
                const sessionCards = this.sessionsList.querySelectorAll('.session-card');
                sessionCards.forEach(card => card.classList.remove('active'));
                event.currentTarget.classList.add('active');
            }
            
            async loadChatHistory(sessionId) {
                try {
                    const response = await fetch(`/api/admin/chat-history?sessionId=${sessionId}`);
                    const data = await response.json();
                    
                    if (data.success && data.messages) {
                        this.chatArea.innerHTML = '';
                        data.messages.forEach(message => {
                            this.addMessageToChat(message.text, message.sender, message.timestamp);
                        });
                    }
                } catch (error) {
                    console.error('Error loading chat history:', error);
                }
            }
            
            enableChatInput() {
                this.messageInput.disabled = false;
                this.sendButton.disabled = false;
                this.messageInput.focus();
            }
            
            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message || !this.currentSessionId) return;
                
                // Add message to chat immediately
                this.addMessageToChat(message, 'admin', new Date().toISOString());
                this.messageInput.value = '';
                
                try {
                    const response = await fetch('/api/admin/send-message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            sessionId: this.currentSessionId,
                            message: message
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        console.error('Failed to send message:', data.message);
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                }
            }
            
            addMessageToChat(text, sender, timestamp) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message-bubble flex items-start space-x-3';
                
                const time = new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                if (sender === 'admin') {
                    messageDiv.innerHTML = `
                        <div class="flex-1"></div>
                        <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-lg p-3 max-w-xs ml-3">
                            <p class="text-sm">${text}</p>
                            <p class="text-xs text-green-200 mt-1">${time}</p>
                        </div>
                        <div class="admin-avatar w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="user-avatar w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="glass-morphism rounded-lg p-3 max-w-xs">
                            <p class="text-sm">${text}</p>
                            <p class="text-xs text-gray-400 mt-1">${time}</p>
                        </div>
                    `;
                }
                
                this.chatArea.appendChild(messageDiv);
                this.scrollToBottom();
            }
            
            scrollToBottom() {
                this.chatArea.scrollTop = this.chatArea.scrollHeight;
            }
            
            clearChat() {
                if (confirm('Are you sure you want to clear this chat?')) {
                    this.chatArea.innerHTML = `
                        <div class="text-center text-gray-400 py-8">
                            <p>Chat cleared. Ready for new messages.</p>
                        </div>
                    `;
                }
            }
            
            async endSession() {
                if (!this.currentSessionId) return;
                
                if (confirm('Are you sure you want to end this session?')) {
                    try {
                        const response = await fetch('/api/admin/end-session', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                sessionId: this.currentSessionId
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            this.currentSessionId = null;
                            this.chatArea.innerHTML = `
                                <div class="text-center text-gray-400 py-8">
                                    <p>Session ended. Select another session to continue.</p>
                                </div>
                            `;
                            this.messageInput.disabled = true;
                            this.sendButton.disabled = true;
                            this.loadSessions();
                        }
                    } catch (error) {
                        console.error('Error ending session:', error);
                    }
                }
            }
            
            logout() {
                if (confirm('Are you sure you want to logout?')) {
                    // Clear session and redirect
                    fetch('/api/auth/logout', { method: 'POST' })
                        .then(() => {
                            window.location.href = '/login.html';
                        })
                        .catch(() => {
                            window.location.href = '/login.html';
                        });
                }
            }
            
            formatTime(timestamp) {
                const now = new Date();
                const time = new Date(timestamp);
                const diff = now - time;
                
                if (diff < 60000) return 'Just now';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
                return time.toLocaleDateString();
            }
            
            startPolling() {
                // Poll for new sessions and messages every 5 seconds
                setInterval(() => {
                    this.loadSessions();
                    
                    if (this.currentSessionId) {
                        this.loadChatHistory(this.currentSessionId);
                    }
                }, 5000);
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            new AdminDashboard();
            
            // Add entrance animation
            anime({
                targets: '.glass-morphism',
                opacity: [0, 1],
                translateY: [30, 0],
                duration: 800,
                delay: anime.stagger(100),
                easing: 'easeOutQuart'
            });
        });
    </script>
</body>
</html>